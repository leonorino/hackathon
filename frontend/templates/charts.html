<div class="w-full grid grid-cols-1 md:grid-cols-2 gap-6 p-4" x-data="chartsData()">
    <div class="bg-white rounded-xl p-4 shadow">
        <h3 class="font-semibold mb-2" x-text="'Выход по току (Eta): ' + eta + '%'"></h3>
        <canvas id="etaChart" x-ref="etaChartCanvas"></canvas>
    </div>

    <div class="bg-white rounded-xl p-4 shadow">
        <h3 class="font-semibold mb-2" x-text="'Уд. расход энергии (E_ud): ' + E_ud + ' кВт·ч/т Al'"></h3>
        <canvas id="eudChart" x-ref="eudChartCanvas"></canvas>
    </div>

    <div class="bg-white rounded-xl p-4 shadow md:col-span-2">
        <h3 class="font-semibold mb-2" x-text="'Расход анодного материала: ' + anode_consumption + ' кг/т Al'"></h3>
        <canvas id="anodeChart" x-ref="anodeChartCanvas"></canvas>
    </div>
</div>

<script>
function chartsData() {
    return {
        eta: 0,
        E_ud: 0,
        anode_consumption: 0,
        etaChart: null,
        eudChart: null,
        anodeChart: null,
        etaHistory: [],
        eudHistory: [],
        anodeHistory: [],
        timeLabels: [],

        init() {
            this.$nextTick(() => {
                this.initializeCharts();
            });
        },

        updateMetrics(newEta, newEud, newAnode) {
            this.eta = newEta;
            this.E_ud = newEud;
            this.anode_consumption = newAnode;

            const now = new Date();
            const timeLabel = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

            this.etaHistory.push(newEta);
            this.eudHistory.push(newEud);
            this.anodeHistory.push(newAnode);
            this.timeLabels.push(timeLabel);

            this.updateCharts();
        },

        updateCharts() {
            console.log(this.etaHistory, this.eudHistory, this.anodeHistory);

            if (this.etaChart && this.eudChart && this.anodeChart) {
                this.etaChart.data.labels = this.timeLabels;
                this.etaChart.data.datasets[0].data = this.etaHistory;
                this.etaChart.update();

                this.eudChart.data.labels = this.timeLabels;
                this.eudChart.data.datasets[0].data = this.eudHistory;
                this.eudChart.update();

                this.anodeChart.data.labels = this.timeLabels;
                this.anodeChart.data.datasets[0].data = this.anodeHistory;
                this.anodeChart.update();
            }
        },

        initializeCharts() {
            const ctx1 = document.getElementById('etaChart').getContext('2d');
            const ctx2 = document.getElementById('eudChart').getContext('2d');
            const ctx3 = document.getElementById('anodeChart').getContext('2d');

            this.etaChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: this.timeLabels,
                    datasets: [{
                        label: 'Eta (%)',
                        data: this.etaHistory,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: '#1f2937', font: { size: 12 } }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 100,
                            ticks: { color: '#4b5563' },
                            grid: { color: '#e5e7eb' }
                        },
                        x: {
                            ticks: { color: '#4b5563' },
                            grid: { color: '#e5e7eb' }
                        }
                    }
                }
            });

            this.eudChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: this.timeLabels,
                    datasets: [{
                        label: 'E_ud (кВт·ч/т)',
                        data: this.eudHistory,
                        backgroundColor: '#059669',
                        borderColor: '#047857',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: '#1f2937', font: { size: 12 } }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#4b5563' },
                            grid: { color: '#e5e7eb' }
                        },
                        x: {
                            ticks: { color: '#4b5563' },
                            grid: { color: '#e5e7eb' }
                        }
                    }
                }
            });

            this.anodeChart = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: this.timeLabels,
                    datasets: [{
                        label: 'Anode Consumption (kg/t)',
                        data: this.anodeHistory,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: '#1f2937', font: { size: 12 } }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#4b5563' },
                            grid: { color: '#e5e7eb' }
                        },
                        x: {
                            ticks: { color: '#4b5563' },
                            grid: { color: '#e5e7eb' }
                        }
                    }
                }
            });
        }
    };
}
</script>
